<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />
    <title>STL Viewer</title>
    <style>
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        background: #fff;
        overflow: hidden;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      }
      #wrap {
        position: relative;
        width: 100%;
        height: 100%;
      }
      #canvas {
        display: block;
        width: 100%;
        height: 100%;
      }
      #hud {
        position: absolute;
        left: 12px;
        bottom: 12px;
        font-size: 12px;
        color: #334155;
        background: rgba(255,255,255,0.9);
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }
      #status {
        position: absolute;
        left: 12px;
        top: 12px;
        font-size: 12px;
        color: #0f172a;
        background: rgba(255,255,255,0.9);
        padding: 6px 8px;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
      }
      #error {
        position: absolute;
        right: 12px;
        top: 12px;
        max-width: min(600px, 80vw);
        white-space: pre-wrap;
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 12px;
        color: #991b1b;
        background: #fef2f2;
        border: 1px solid #fecaca;
        padding: 8px 10px;
        border-radius: 6px;
        display: none;
      }
    </style>
  </head>
  <body>
    <div id="wrap">
      <canvas id="canvas"></canvas>
      <div id="status">Cargando STL…</div>
      <div id="hud">Arrastra para rotar · Rueda para zoom · Shift+arrastrar para pan</div>
      <div id="error"></div>
    </div>

    <!-- Three.js + extras desde CDN oficiales -->
    <script type="module">
      import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
      import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";
      import { STLLoader } from "https://unpkg.com/three@0.160.0/examples/jsm/loaders/STLLoader.js";

      const params = new URLSearchParams(location.search);
      const src = params.get("src");

      const $status = document.getElementById("status");
      const $error = document.getElementById("error");
      const canvas = document.getElementById("canvas");
      const wrap = document.getElementById("wrap");

      let renderer, scene, camera, controls, mesh;

      function showError(msg) {
        $error.textContent = String(msg ?? "Error desconocido");
        $error.style.display = "block";
        $status.style.display = "none";
      }

      function setStatus(txt) {
        $status.textContent = txt;
        $status.style.display = "block";
      }

      function init() {
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xffffff);

        const width = wrap.clientWidth;
        const height = wrap.clientHeight;

        camera = new THREE.PerspectiveCamera(50, width / height, 0.1, 10000);
        camera.position.set(200, 150, 200);

        renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        renderer.setSize(width, height);

        controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.enablePan = true;
        controls.panSpeed = 1.0;
        controls.rotateSpeed = 0.9;
        controls.zoomSpeed = 0.9;
        controls.screenSpacePanning = true;
        controls.mouseButtons = {
          LEFT: THREE.MOUSE.ROTATE,
          MIDDLE: THREE.MOUSE.DOLLY,
          RIGHT: THREE.MOUSE.PAN,
        };
        controls.keys = {
          LEFT: "ArrowLeft",
          UP: "ArrowUp",
          RIGHT: "ArrowRight",
          BOTTOM: "ArrowDown",
        };

        // Luz suave
        scene.add(new THREE.AmbientLight(0xffffff, 0.8));
        const dir = new THREE.DirectionalLight(0xffffff, 0.9);
        dir.position.set(1, 1.5, 1).multiplyScalar(200);
        scene.add(dir);

        // Plano de suelo muy sutil
        const grid = new THREE.GridHelper(1000, 20, 0xe5e7eb, 0xf1f5f9);
        grid.position.y = -0.001;
        scene.add(grid);

        window.addEventListener("resize", onResize);
        animate();
      }

      function onResize() {
        const w = wrap.clientWidth;
        const h = wrap.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      }

      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }

      function frameObject(object3D) {
        const box = new THREE.Box3().setFromObject(object3D);
        const size = box.getSize(new THREE.Vector3());
        const center = box.getCenter(new THREE.Vector3());

        // Centrar el objeto en el origen
        object3D.position.x += object3D.position.x - center.x;
        object3D.position.y += object3D.position.y - center.y;
        object3D.position.z += object3D.position.z - center.z;

        const maxDim = Math.max(size.x, size.y, size.z) || 1;
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / (2 * Math.tan(fov / 2)));

        cameraZ *= 1.6; // margen
        camera.position.set(center.x + cameraZ, center.y + cameraZ * 0.8, center.z + cameraZ);
        camera.near = cameraZ / 100;
        camera.far = cameraZ * 100;
        camera.updateProjectionMatrix();

        controls.target.copy(center);
        controls.update();
      }

      async function loadSTL(url) {
        if (!url) {
          setStatus("Esperando URL…");
          return;
        }

        setStatus("Cargando STL…");

        try {
          // Carga directa (URLs firmadas de Supabase funcionan con GET anónimo)
          const loader = new STLLoader();
          // CORS amigable
          loader.manager.setCrossOrigin("anonymous");

          loader.load(
            url,
            (geometry) => {
              // Material oscuro sutil
              const material = new THREE.MeshPhongMaterial({
                color: 0x0f172a,
                specular: 0x111111,
                shininess: 12,
              });

              // Liberar mesh previo
              if (mesh) {
                scene.remove(mesh);
                mesh.geometry.dispose();
                mesh.material.dispose();
              }

              mesh = new THREE.Mesh(geometry, material);
              mesh.castShadow = true;
              mesh.receiveShadow = true;

              scene.add(mesh);
              frameObject(mesh);
              setStatus("Listo");
              setTimeout(() => ($status.style.display = "none"), 1200);
            },
            (xhr) => {
              // progreso
              if (xhr.lengthComputable) {
                const p = Math.round((xhr.loaded / xhr.total) * 100);
                setStatus(`Cargando STL… ${p}%`);
              }
            },
            (err) => {
              console.error(err);
              showError(`No se pudo cargar el STL.\n${err?.message ?? err}`);
            }
          );
        } catch (e) {
          console.error(e);
          showError(`Error general cargando STL.\n${e?.message ?? e}`);
        }
      }

      init();
      loadSTL(src);
    </script>
  </body>
</html>
